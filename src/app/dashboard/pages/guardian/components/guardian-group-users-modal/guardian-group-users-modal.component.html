<ng-container *ngLet="rows$ | async as rows">
  <ng-container *ngIf="isFormReady$ | async; else formLoadingTpl">
    <form nz-form [formGroup]="form" nzLayout="vertical" novalidate>
      <div nz-row [nzGutter]="[24, 12]">
        <div nz-col [nzSpan]="17" [nzFlex]="1">
          <nz-form-item>
            <app-form-label>
              <nz-form-label nzFor="public-key" nzRequired>
                User public key
              </nz-form-label>
            </app-form-label>
            <nz-form-control
              id="public-key"
              nzErrorTip="Please select an user!"
              nzHasFeedback
            >
              <app-wallet-select
                [ownerAddress]="selectedProfileAddress | async"
                formControlName="wallet"
                labelProp="publicKey"
                placeholder="Select wallet public key"
              >
              </app-wallet-select>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="7" [nzFlex]="1">
          <nz-form-item>
            <app-form-label>
              <nz-form-label>&nbsp;</nz-form-label>
            </app-form-label>
            <nz-form-control>
              <ng-container *ngLet="c('wallet').valueChanges">
                <button nz-button nzType="default" class="w-100" [disabled]="!c('wallet').value"
                        (click)="onAddUser($event)">
                  Add user to group
                </button>
              </ng-container>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <nz-form-item>
        <app-table
          [rows]="rows"
          [tableColumns]="tableColumns"
          scrollY="70vh"
        >
        </app-table>
      </nz-form-item>
    </form>
  </ng-container>
</ng-container>

<ng-template #formLoadingTpl>
  <nz-spin nzSimple class="text-center"></nz-spin>
</ng-template>

<ng-template #modalTitleTpl>
  <app-modal-header>
    <nz-space>
      <nz-space-item>
        <h4 nz-typography nzType="secondary" class="text-capitalize">
          <ng-container *ngIf="group$ | async as group">
            Manage group "{{group.name}}" users
          </ng-container>
        </h4>
      </nz-space-item>
      <nz-space-item>
        <app-popover-helper
          placement="right"
          [popoverContent]="modalTitleHelperTpl"
        ></app-popover-helper>
      </nz-space-item>
    </nz-space>
  </app-modal-header>
  <ng-template #modalTitleHelperTpl>
    Manage group users by adding them in table
  </ng-template>
</ng-template>

<div *nzModalFooter>
  <button
    class="text-capitalize"
    nz-button
    nzType="primary"
    [nzLoading]="isLoading$ | async"
    [disabled]="(isLoading$ | async) || !form.valid"
    (click)="submitForm($event)"
  >
    Save changes
  </button>
</div>

<ng-template #publicKeyTpl let-row="row">
  <app-text-clipper
    [text]="row.publicKey"
    [copy]="true"
  ></app-text-clipper>
</ng-template>
